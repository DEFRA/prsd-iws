@using EA.Iws.Web.Areas.ImportNotification.Views.WasteType;
@using EA.Iws.Web.Areas.ImportNotification.ViewModels.Shared;
@model EA.Iws.Web.Areas.ImportNotification.ViewModels.WasteType.WasteTypeViewModel
@{
    ViewBag.Title = IndexResources.Title;
}
@helper DisplayCodeTable(string tableId, string tableHeading, string code, IList<WasteCodeViewModel> selectedCodesForDisplay)
{
    <table id="@tableId" class="import-draft-codes-table">
        <thead>
            <tr>
                <th colspan="2">@tableHeading</th>
            </tr>
        </thead>
        <tbody>
            @if (!selectedCodesForDisplay.Any())
            {
                <tr data-content="empty" class="empty"><td>@IndexResources.NoCodes</td><td>&nbsp;</td></tr>
            }
            @foreach (var item in selectedCodesForDisplay)
            {
                <tr id="row-@item.Id">
                    <td>@item.Name</td>
                    <td class="remove">
                        <button data-action="remove" data-code-id="@item.Id" data-code-type="@code" type="button">
                            @IndexResources.RemoveCodeButton
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}
<header class="hgroup"><h1 class="heading-large">@IndexResources.MainHeading</h1></header>

@using (Html.BeginForm())
{
    @Html.AntiForgeryToken()

    <div class="form-group large-bottom-margin @Html.Gds().FormGroupClass(m => m.Name)">
        @Html.Gds().LabelFor(m => m.Name, showOptionalLabel: false)
        @Html.Gds().TextBoxFor(m => m.Name, new { maxLength = 70 })
    </div>

    <h2 class="heading-medium">Waste codes</h2>

    <hr />

    <div class="form-group-compound @Html.Gds().FormGroupClass(m => m.SelectedBaselCode)">
        @Html.Gds().LabelFor(m => m.SelectedBaselCode, showOptionalLabel: false)
        @Html.Gds().DropDownListFor(m => m.SelectedBaselCode, Model.BaselCodes, string.Empty, new { data_type = "waste-codes" })
    </div>

    <div class="form-group large-bottom-margin @Html.Gds().FormGroupClass(m => m.BaselCodeNotListed)">
        <label for="BaselCodeNotListed">
            @Html.CheckBoxFor(m => m.BaselCodeNotListed)
            @Html.DisplayNameFor(m => m.BaselCodeNotListed)
        </label>
    </div>

    <div class="grid-row">
        <div class="column-half">
            <div class="form-group medium-bottom-margin @Html.Gds().FormGroupClass(m => m.SelectedEwcCode)">
                @Html.Gds().LabelFor(m => m.SelectedEwcCode, showOptionalLabel: false)
                @Html.Gds().DropDownListFor(m => m.SelectedEwcCode, Model.EwcCodes, string.Empty, new { data_type = "waste-codes" })
                @Html.HiddenFor(model => Model.SelectedEwcCodesJson)
                <button type="button" id="add-ewc-code" class="add">Add</button>
            </div>

            <div class="form-group large-bottom-margin">
                @DisplayCodeTable("ewc-codes-table", IndexResources.EwcCodesTableHeading, "ewc", Model.SelectedEwcCodesDisplay)
            </div>
        </div>
        <div class="column-half">
            <div class="form-group-compound @Html.Gds().FormGroupClass(m => m.SelectedHCode)">
                @Html.Gds().LabelFor(m => m.SelectedHCode, showOptionalLabel: false)
                @Html.Gds().DropDownListFor(m => m.SelectedHCode, Model.HCodes, string.Empty, new { data_type = "waste-codes" })
                @Html.HiddenFor(model => Model.SelectedHCodesJson)
                <button type="button" id="add-h-code" class="add">Add</button>
            </div>

            <div class="form-group-compound @Html.Gds().FormGroupClass(m => m.HCodeNotApplicable)">
                <label for="HCodeNotApplicable">
                    @Html.CheckBoxFor(m => m.HCodeNotApplicable)
                    @Html.DisplayNameFor(m => m.HCodeNotApplicable)
                </label>
            </div>

            <div class="form-group large-bottom-margin">
                @DisplayCodeTable("h-codes-table", IndexResources.HCodesTableHeading, "h", Model.SelectedHCodesDisplay)
            </div>
        </div>
    </div>
    <div class="grid-row">
        <div class="column-half">
            <div class="form-group-compound @Html.Gds().FormGroupClass(m => m.SelectedYCode)">
                @Html.Gds().LabelFor(m => m.SelectedYCode, showOptionalLabel: false)
                @Html.Gds().DropDownListFor(m => m.SelectedYCode, Model.YCodes, string.Empty, new { data_type = "waste-codes" })
                @Html.HiddenFor(model => Model.SelectedYCodesJson)
                <button type="button" id="add-y-code" class="add">Add</button>
            </div>

            <div class="form-group-compound @Html.Gds().FormGroupClass(m => m.YCodeNotApplicable)">
                <label for="YCodeNotApplicable">
                    @Html.CheckBoxFor(m => m.YCodeNotApplicable)
                    @Html.DisplayNameFor(m => m.YCodeNotApplicable)
                </label>
            </div>

            <div class="form-group large-bottom-margin">
                @DisplayCodeTable("y-codes-table", IndexResources.YCodesTableHeading, "y", Model.SelectedYCodesDisplay)
            </div>
        </div>

        <div class="column-half">
            <div class="form-group-compound @Html.Gds().FormGroupClass(m => m.SelectedUnClass)">
                @Html.Gds().LabelFor(m => m.SelectedUnClass, showOptionalLabel: false)
                @Html.Gds().DropDownListFor(m => m.SelectedUnClass, Model.UnClasses, string.Empty, new { data_type = "waste-codes" })
                @Html.HiddenFor(model => Model.SelectedUnClassesJson)
                <button type="button" id="add-un-class" class="add">Add</button>
            </div>

            <div class="form-group-compound @Html.Gds().FormGroupClass(m => m.UnClassNotApplicable)">
                <label for="UnClassNotApplicable">
                    @Html.CheckBoxFor(m => m.UnClassNotApplicable)
                    @Html.DisplayNameFor(m => m.UnClassNotApplicable)
                </label>
            </div>

            <div class="form-group large-bottom-margin">
                @DisplayCodeTable("un-classes-table", IndexResources.UnClassesTableHeading, "un", Model.SelectedUnClassesDisplay)
            </div>
        </div>
    </div>

    <div class="form-group">
        <button type="submit" class="button">@Constants.ContinueButtonText</button>
    </div>
}

@section scripts{
    <script>
        $(function () {
            $('select[data-type="waste-codes"]').selectToAutocomplete();
        });

        $('#add-ewc-code').click(function () {
            addCode('#SelectedEwcCodesJson', '#SelectedEwcCode', '#ewc-empty-table-row', '#ewc-codes-table');
        })

        $('#add-y-code').click(function () {
            addCode('#SelectedYCodesJson', '#SelectedYCode', '#y-empty-table-row', '#y-codes-table');
        })

        $('#add-h-code').click(function () {
            addCode('#SelectedHCodesJson', '#SelectedHCode', '#h-empty-table-row', '#h-codes-table');
        })

        $('#add-un-class').click(function () {
            addCode('#SelectedUnClassesJson', '#SelectedUnClass', '#un-empty-table-row', '#un-classes-table');
        })

        $('button[data-action="remove"][data-code-type="ewc"]').click(function () {
            removeCode(this, '#SelectedEwcCodesJson');
        })
        
        $('button[data-action="remove"][data-code-type="y"]').click(function () {
            removeCode(this, '#SelectedYCodesJson');
        })

        $('button[data-action="remove"][data-code-type="h"]').click(function () {
            removeCode(this, '#SelectedHCodesJson');
        })

        $('button[data-action="remove"][data-code-type="un"]').click(function () {
            removeCode(this, '#SelectedUnClassesJson');
        })

        function addCode(currentCodesJsonId, selectedCodeId, emptyRowId, codeTableId) {
            var elems = [];
            var currentVals = $(currentCodesJsonId).val();

            if (currentVals !== '') {
                //read the current hidden field into JSON array
                elems = JSON.parse(currentVals);
            }

            var newValue = $(selectedCodeId).val();

            if (newValue !== '' && $.inArray(newValue, elems) == -1) {
                //update the JSON hidden field
                elems.push(newValue);
                $(currentCodesJsonId).val(JSON.stringify(elems));

                //update the display table
                $(codeTableId + ' tr[data-content="empty"]').remove();

                $(codeTableId + ' > tbody:last-child').append('<tr id="row-' + newValue + '"><td>'
                    + $(selectedCodeId + ' option:selected').text()
                    + '</td><td class="remove"><button type="button" data-action="remove" '
                    + 'id="remove-' + newValue + '" data-code-id="' + newValue + '">'
                    + '@IndexResources.RemoveCodeButton</button></td></tr>');

                //add 'remove' event handler to new button
                $('#remove-' + newValue).click(function () {
                    removeCode(this, currentCodesJsonId);
                })

                //clear the input field
                $(selectedCodeId).val('').change();
                $(selectedCodeId).next('input.ui-autocomplete-input').val('').change();
            }
        }

        function removeCode(button, jsonCodeId) {
            var codeId = $(button).data('code-id');

            var codes = $(jsonCodeId);
           
            var elems = [];
            if (codes.val() != '') {
                elems = JSON.parse(codes.val());
                var indexInArray = $.inArray(codeId, elems);
                if (indexInArray !== -1) {
                    elems.splice(indexInArray, 1);
                    codes.val(JSON.stringify(elems));
                }
            }

            var row = $('#row-' + codeId);

            if (row.parent().children().length == 1) {
                row.parent(':last-child').append('<tr data-content="empty" class="empty"><td>'
                    + '@IndexResources.NoCodes</td><td>&nbsp;</td></tr>')
            }

            row.remove();
        }
    </script>
}