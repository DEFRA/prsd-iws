IF OBJECT_ID('[Reports].[uspUpdateReportCache]') IS NULL
    EXEC('CREATE PROCEDURE [Reports].[uspUpdateReportCache] AS SET NOCOUNT ON;')
GO

ALTER PROCEDURE [Reports].[uspUpdateReportCache]
AS
BEGIN

    DELETE FROM [Reports].[FreedomOfInformationCache];
    DELETE FROM [Reports].[ShipmentsCache];

    INSERT INTO [Reports].[FreedomOfInformationCache] (
           [NotificationNumber]
          ,[ImportOrExport]
          ,[IsInterim]
          ,[ReceivedDate]
          ,[CompetentAuthorityId]
          ,[NotifierName]
          ,[NotifierAddress]
          ,[NotifierPostalCode]
          ,[ProducerName]
          ,[ProducerAddress]
          ,[ProducerPostalCode]
          ,[PointOfExport]
          ,[PointOfEntry]
          ,[ImportCountryName]
          ,[ChemicalCompositionTypeId]
          ,[NameOfWaste]
          ,[EWC]
          ,[YCode]
          ,[HCode]
          ,[OperationCodes]
          ,[ImporterName]
          ,[ImporterAddress]
          ,[ImporterPostalCode]
          ,[FacilityName]
          ,[FacilityAddress]
          ,[FacilityPostalCode]
          ,[IntendedQuantity]
          ,[IntendedQuantityUnit]
          ,[IntendedQuantityUnitId]
          ,[ConsentFrom]
          ,[ConsentTo]
          ,[LocalArea]
          ,[MovementNumber]
          ,[MovementReceivedDate]
          ,[MovementCompletedDate]
          ,[MovementQuantityReceviedUnitId]
          ,[MovementQuantityReceived]
          ,[BaselOecdCode]
          ,[ExportCountryName]
		  ,[NotifierType]
		  ,[NotifierContactName]
		  ,[NotifierContactEmail]
		  ,[ProducerType]
		  ,[ProducerContactEmail]
		  ,[TransitStates]
		  ,[ImporterType]
		  ,[ImporterContactName]
		  ,[ImporterContactEmail]
		  ,[NotificationStatus]
          ,[NotificationStatusAtFileClosed]
		  ,[DecisionRequiredByDate]
		  ,[IsFinancialGuaranteeApproved]
		  ,[FileClosedDate]
		  ,[TechnologyEmployed]
		  ,[ActualDate]
		  ,[AcknowledgedDate]
		  ,[ObjectionDate]
		  ,[WithdrawnDate]
		  ,[SiteOfExportName]
		  ,[Officer] )
    SELECT [NotificationNumber]
          ,[ImportOrExport]
          ,[IsInterim]
          ,[ReceivedDate]
          ,[CompetentAuthorityId]
          ,[NotifierName]
          ,[NotifierAddress]
          ,[NotifierPostalCode]
          ,[ProducerName]
          ,[ProducerAddress]
          ,[ProducerPostalCode]
          ,[PointOfExport]
          ,[PointOfEntry]
          ,[ImportCountryName]
          ,[ChemicalCompositionTypeId]
          ,[NameOfWaste]
          ,[EWC]
          ,[YCode]
          ,[HCode]
          ,[OperationCodes]
          ,[ImporterName]
          ,[ImporterAddress]
          ,[ImporterPostalCode]
          ,[FacilityName]
          ,[FacilityAddress]
          ,[FacilityPostalCode]
          ,[IntendedQuantity]
          ,[IntendedQuantityUnit]
          ,[IntendedQuantityUnitId]
          ,[ConsentFrom]
          ,[ConsentTo]
          ,[LocalArea]
          ,[MovementNumber]
          ,[MovementReceivedDate]
          ,[MovementCompletedDate]
          ,[MovementQuantityReceviedUnitId]
          ,[MovementQuantityReceived]
          ,[BaselOecdCode]
          ,[ExportCountryName]
		  ,[NotifierType]
		  ,[NotifierContactName]
		  ,[NotifierContactEmail]
		  ,[ProducerType]
		  ,[ProducerContactEmail]
		  ,[TransitStates]
		  ,[ImporterType]
		  ,[ImporterContactName]
		  ,[ImporterContactEmail]
		  ,[NotificationStatus]
          ,[NotificationStatusAtFileClosed]
		  ,[DecisionRequiredByDate]
		  ,[IsFinancialGuaranteeApproved]
		  ,[FileClosedDate]
		  ,[TechnologyEmployed]
		  ,[ActualDate]
		  ,[AcknowledgedDate]
		  ,[ObjectionDate]
		  ,[WithdrawnDate]
		  ,[SiteOfExportName]
		  ,[Officer]
      FROM [Reports].[FreedomOfInformation];

    INSERT INTO [Reports].[ShipmentsCache] (
           [NotificationId]
          ,[NotificationNumber]
          ,[CompetentAuthorityId]
          ,[Exporter]
          ,[NotifierCompanyType]
          ,[Importer]
          ,[ConsigneeCompanyType]
          ,[Facility]
          ,[FacilityCompanyType]
          ,[ShipmentNumber]
          ,[ActualDateOfShipment]
          ,[ConsentFrom]
          ,[ConsentTo]
          ,[PrenotificationDate]
          ,[ReceivedDate]
          ,[CompletedDate]
          ,[QuantityReceived]
          ,[QuantityReceivedUnit]
          ,[QuantityReceivedUnitId]
          ,[ChemicalCompositionTypeId]
          ,[ChemicalComposition]
          ,[LocalArea]
          ,[TotalQuantity]
          ,[TotalQuantityUnits]
          ,[TotalQuantityUnitsId]
          ,[EntryPort]
          ,[DestinationCountry]
          ,[ExitPort]
          ,[OriginatingCountry]
          ,[Status]
          ,[NotificationReceivedDate]
          ,[EwcCodes]
          ,[ImportOrExport]
          ,[BaselOecdCode]
          ,[OperationCodes]
          ,[YCode]
          ,[HCode]
          ,[UNClass]
		  ,[SiteOfExportName]
		  ,[RejectedShipmentDate] 
          ,[RejectedReason]
          ,[ActionedByExternalUser])
    SELECT [NotificationId]
          ,[NotificationNumber]
          ,[CompetentAuthorityId]
          ,[Exporter]
          ,[NotifierCompanyType]
          ,[Importer]
		  ,[ConsigneeCompanyType]
          ,[Facility]
		  ,[FacilityCompanyType]
          ,[ShipmentNumber]
          ,[ActualDateOfShipment]
          ,[ConsentFrom]
          ,[ConsentTo]
          ,[PrenotificationDate]
          ,[ReceivedDate]
          ,[CompletedDate]
          ,[QuantityReceived]
          ,[QuantityReceivedUnit]
          ,[QuantityReceivedUnitId]
          ,[ChemicalCompositionTypeId]
          ,[ChemicalComposition]
          ,[LocalArea]
          ,[TotalQuantity]
          ,[TotalQuantityUnits]
          ,[TotalQuantityUnitsId]
          ,[EntryPort]
          ,[DestinationCountry]
          ,[ExitPort]
          ,[OriginatingCountry]
          ,[Status]
          ,[NotificationReceivedDate]
          ,[EwcCodes]
          ,[ImportOrExport]
          ,[BaselOecdCode]
          ,[OperationCodes]
          ,[YCode]
          ,[HCode]
          ,[UNClass]
		  ,[SiteOfExportName]
		  ,[RejectedShipmentDate]
          ,[RejectedReason]
          ,[ActionedByExternalUser]
      FROM [Reports].[Shipments];

    DECLARE @NotificationId NVARCHAR(MAX);
	DECLARE @ShipmentNumber INT;
	SELECT NotificationId, ShipmentNumber INTO [#ShipmentsCacheTempTable] FROM [Reports].[ShipmentsCache] WHERE ActionedByExternalUser = 'N';

	WHILE (SELECT COUNT(*) FROM #ShipmentsCacheTempTable) > 0
		BEGIN
			SELECT TOP 1 @NotificationId=NotificationId, @shipmentNumber=ShipmentNumber FROM #ShipmentsCacheTempTable ORDER BY NotificationId, ShipmentNumber;
    
			SELECT UserId INTO [#MovementAuditUserTempTable] FROM [Notification].[MovementAudit] WHERE NotificationId=@NotificationId AND ShipmentNumber=@ShipmentNumber AND Type IN (1, 3, 4, 5);
		
			DECLARE @IsExternalUser NVARCHAR(1) = 'N';
			DECLARE @UserId NVARCHAR(MAX);
		
			WHILE (SELECT COUNT(*) FROM #MovementAuditUserTempTable) > 0
				BEGIN
					SELECT TOP 1 @UserId=UserId FROM #MovementAuditUserTempTable;				
				
					IF(@UserId IS NOT NULL AND @UserId != '')
						BEGIN 
							IF((SELECT COUNT(*) FROM [Person].[InternalUser] WHERE UserId = @UserId) = 0)
								BEGIN
									SET @IsExternalUser = 'Y';
								END

							DELETE #MovementAuditUserTempTable WHERE UserId=@UserId;
						END
				END
			DROP TABLE #MovementAuditUserTempTable;
	
			UPDATE [Reports].[ShipmentsCache] SET ActionedByExternalUser=@IsExternalUser WHERE NotificationId=@NotificationId AND ShipmentNumber=@ShipmentNumber;

			DELETE #ShipmentsCacheTempTable WHERE NotificationId=@NotificationId AND ShipmentNumber=@ShipmentNumber;
		END

	DROP TABLE #ShipmentsCacheTempTable;

	DELETE FROM [Reports].[ProducerCache];

	INSERT INTO [Reports].[ProducerCache](
			[NotificationNumber] 
			,[CompetentAuthorityId] 
			,[NotifierName] 
			,[ProducerName] 
			,[ProducerAddress1] 
			,[ProducerAddress2] 
			,[ProducerTownOrCity] 
			,[ProducerPostCode] 
			,[SiteOfExport] 
			,[LocalArea] 
			,[WasteType] 
			,[NotificationStatus]
			,[ConsigneeName] 
			,[ConsentFrom] 
			,[ConsentTo] 
			,[NotificationReceivedDate] 
			,[MovementReceivedDate] 
			,[MovementCompletedDate] 
			,[EwcCode] 
			,[YCode] 
			,[PointOfExit] 
			,[PointOfEntry] 
			,[ExportCountryName] 
			,[ImportCountryName] 
			,[SiteOfExportName] 
			,[FacilityName] )
	SELECT [NotificationNumber] 
			,[CompetentAuthorityId] 
			,[NotifierName] 
			,[ProducerName] 
			,[ProducerAddress1] 
			,[ProducerAddress2] 
			,[ProducerTownOrCity] 
			,[ProducerPostCode] 
			,[SiteOfExport] 
			,[LocalArea] 
			,[WasteType] 
			,[NotificationStatus]
			,[ConsigneeName] 
			,[ConsentFrom] 
			,[ConsentTo] 
			,[NotificationReceivedDate] 
			,[MovementReceivedDate] 
			,[MovementCompletedDate] 
			,[EwcCode] 
			,[YCode] 
			,[PointOfExit] 
			,[PointOfEntry] 
			,[ExportCountryName] 
			,[ImportCountryName] 
			,[SiteOfExportName] 
			,[FacilityName] 
	FROM [Reports].[Producers]

END
GO